<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script>
  window.onload = startupFunction;

  function startupFunction() {
    let url = new URL(location);
    let state = document.querySelector(".recipe-container").innerHTML;
    history.replaceState({ html: state }, "", url);
    let searchbar = document.querySelector("#search")
    searchbar.addEventListener("keydown",(e)=>{
      if (e.code === "Enter") {  //checks whether the pressed key is "Enter"
        search(e.target.value);
      }
    })
  }

  function render_recipes(recipes) {
    let current_recipes = document.querySelectorAll(
      ".recipe-container > .recipe-card"
    );
    current_recipes.forEach((element) => {
      element.remove();
    });
    let container = document.querySelector(".recipe-container");
    recipes.forEach((recipe) => {
      container.innerHTML =
        container.innerHTML +
        `
        <div class="recipe-card">
          <img
          src="../static/Images/chicken-and-waffle.webp"
          alt="chicken-and-waffle"
          />
          <div class="recipe-details" date-category="">
            <ul>
              <li>Time: ${recipe.minutes} minutes</li>
              <li>Servings: 4</li>
              <li>Calories:${recipe.calories}</li>
            </ul>
          </div>
          <p class="recipe-description">${recipe.name}</p>
          <button class="save-button ${
            recipe.favorited ? "favorited" : ""
          }" onClick="favoriteToggle(${recipe.id})">${
          recipe.favorited ? "Saved" : "Save Recipe"
        }</button>
          <button class="info-button">More Info</button>
        </div>`;
    });
  }

  function search() {
    search_term = document.querySelector("#search");
    fetch(
      "/home?" +
        new URLSearchParams({
          search: search_term.value,
        }),
      {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      }
    )
      .then((response) => response.json())
      .then((data) => {
        render_recipes(data.recipes);
        let state = document.querySelector(".recipe-container").innerHTML;
        const url = new URL(location);
        url.searchParams.set("search", search_term.value);
        history.pushState({ html: state }, "", url);
      });
  }

  function handleSaveButton(favorited, button) {
    button.innerHTML = favorited ? "Saved" : "Save Recipe";
    let state = document.querySelector(".recipe-container").innerHTML;
    const url = new URL(location);
    history.replaceState({ html: state }, "", url);
  }

  function favoriteToggle(id) {
    button = event.target;
    fetch("/favoriteToggle", {
      method: "POST",
      body: JSON.stringify({ recipe_id: id }),
    })
      .then((response) => {
        return response.json();
      })
      .then((data) => {
        handleSaveButton((favorited = data.favorited), (button = button));
      });
  }

  window.onpopstate = function (e) {
    fetch(`${location.href}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        render_recipes(data.recipes);
        let state = document.querySelector(".recipe-container").innerHTML;
        history.replaceState({ html: state }, "", location.href);
      });
    if (e.state) {
      document.querySelector(".recipe-container").innerHTML = e.state.html;
    }
  };
</script>

<style>
  .sorting {
    display: flex;
    flex-direction: column; /* Arrange children vertically */
    align-items: center; /* Center children horizontally */
    margin-top: 100px;
}
  
  .searchbar {
    display: flex;
    justify-content: center; /* Centers search bar & button */
    align-items: center;
    width: 90%; /* This controls how wide the search bar is */
}

.searchbar input,

.searchbar button {
  margin-right: 10px; /* Spacing between input and button */
  padding: 10px;
  border: none;
  border-radius: 25px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  font-size: 16px;
  outline: none;
  background-color: #ffffff;
  cursor: pointer;
}

.searchbar button:hover {
  background-color: #e5e5e5;
}

#search {
  width: 30%;  /* search bar width */
  padding: 10px 40px 10px 20px;
  border: none;
  border-radius: 25px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  font-size: 16px;
  outline: none;
  background-color: #ffffff;
  position: relative;
}



.dropdown-container {
  display: flex;
  justify-content: center;
  gap: 20px; /* Space between dropdowns */
  margin-top: 30px; /* Space between search bar and dropdowns */
}

.dropdown-container select {
  width: 200px;
  padding: 10px;
  border: none;
  border-radius: 15px; 
  background-color: #ffffff;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  font-size: 16px;
  outline: none;
  appearance: none; 
  cursor: pointer;
}

</style>

<!-- FILTER TESTING START -->
<div class="sorting">
  <div class="searchbar">
    <input type="text" id="search" name="search" placeholder="Search" />
    <button class="searchButton" type="submit" onclick="search()">
        <i class="fas fa-search"></i>
    </button>
  </div>
  <div class="dropdown-container">
    <!-- Category Dropdown -->
    <div class="category-dropdown">
      <select id="categorySelect">
        <option value="" disabled selected>Select Category</option>
        <option value="all">All Categories</option>
        <option value="breakfast">Breakfast</option>
        <option value="lunch">Lunch</option>
        <option value="dinner">Dinner</option>
      </select>
    </div>
    <!-- Difficulty Dropdown -->
    <div class="difficulty-dropdown">
      <select id="difficultySelect">
        <option value="" disabled selected>Select Difficulties</option>
        <option value="all">All Difficulty</option>
        <option value="beginner">Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>
    </div>
  </div>
</div>
